<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Remap ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #111; color: #FFD700; font-family: Kanit, sans-serif; margin: 0; }
    .container { max-width: 420px; margin: auto; background: #222; padding: 32px 24px 24px 24px; border-radius: 18px; box-shadow: 0 4px 16px #000c; margin-top: 40px;}
    h2 { color: #FFD700; }
    label { display: block; margin-top: 20px; color: #FFD700; }
    input, button { width: 100%; padding: 11px; margin-top: 8px; border-radius: 8px; border: none; }
    input { background: #222; color: #FFD700; border: 1.5px solid #FFD700; font-size: 1.1rem;}
    .car-list { margin-top: 20px; }
    .car-box { background: #191919; border: 1px solid #FFD70055; padding: 12px; margin-bottom: 14px; border-radius: 8px;}
    button { background: linear-gradient(90deg, #FFD700, #222); color: #222; font-weight: bold; font-size: 1.15rem; border: none;}
    .close-btn { background: #FFD700; color: #111; margin-top: 16px;}
    .add-car-btn { margin-top: 18px; background: #FFD70044; color: #FFD700;}
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Remap ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</h2>
    <form id="regForm" autocomplete="off">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
      <input type="text" name="name" required>
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input type="text" name="tel" pattern="[0-9]{9,10}" required>
      <div class="car-list" id="carList"></div>
      <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
      <input type="text" name="carNo" required>
      <button type="button" class="add-car-btn" onclick="addCar()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      <button type="submit" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>
    <div id="successMsg" class="hidden">
      <p>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
      <button class="close-btn" onclick="closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>
  <script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    const LIFF_ID = '2007499630-0J5jPaaP';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzgxZDe7c8aKLyNvJPVvwB-OGZjXX_Q4EygpRCgxSiSu595e2sSqb5YXQwuvHqHe05kHw/exec';
    let userId = '';
    let carData = []; // array of {name, tel, carNo}

    // ‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö userId
    async function initLIFF(){
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      userId = profile.userId;
      // console.log("userId = ", userId); // debug
    }
    // ‡∏£‡∏≠ init liff ‡πÄ‡∏™‡∏£‡πá‡∏à
    let liffReady = initLIFF();

    function addCar() {
      const name = document.querySelector('input[name="name"]').value.trim();
      const tel = document.querySelector('input[name="tel"]').value.trim();
      const carNo = document.querySelector('input[name="carNo"]').value.trim();
      if(name && tel && carNo){
        carData.push({name, tel, carNo});
        updateCarList();
        document.querySelector('input[name="carNo"]').value = '';
      }
    }

    function updateCarList(){
      const carList = document.getElementById('carList');
      carList.innerHTML = '';
      carData.forEach((car, i) => {
        carList.innerHTML += `<div class="car-box">üöó <b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> ${car.carNo}<br><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${car.name} <b>‡πÇ‡∏ó‡∏£:</b> ${car.tel}
          <span style="float:right; color:#FFD700; cursor:pointer" onclick="removeCar(${i})">‚úï</span></div>`;
      });
    }

    function removeCar(idx){
      carData.splice(idx,1);
      updateCarList();
    }

    document.getElementById('regForm').onsubmit = async (e) => {
      e.preventDefault();
      await liffReady; // ‡∏£‡∏≠‡πÉ‡∏´‡πâ LIFF init ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const name = document.querySelector('input[name="name"]').value.trim();
      const tel = document.querySelector('input[name="tel"]').value.trim();
      const carNo = document.querySelector('input[name="carNo"]').value.trim();
      // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏ô
      if(name && tel && carNo && (carData.length === 0 || carData[carData.length-1].carNo !== carNo)) {
        carData.push({name, tel, carNo});
      }
      if(carData.length === 0){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏±‡∏ô');
        document.getElementById('saveBtn').disabled = false;
        return;
      }
      document.getElementById('saveBtn').disabled = true;

      // POST ‡πÑ‡∏õ Apps Script
      try {
        const payload = {
          userId: userId,
          carData: carData
        };
        // console.log("payload = ", payload); // debug
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        // console.log(data); // debug
        if(data.status === "ok"){
          await sendFlexSuccess(carData);
          document.getElementById('regForm').classList.add('hidden');
          document.getElementById('successMsg').classList.remove('hidden');
          carData = []; // reset
          updateCarList();
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'));
        }
      } catch (err) {
        alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message);
      } finally {
        document.getElementById('saveBtn').disabled = false;
      }
    };

    async function sendFlexSuccess(carList){
      // ‡∏™‡πà‡∏á flex message ‡πÑ‡∏õ chat ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
      if(!liff.isInClient()) return;
      const flex = {
        "type": "flex",
        "altText": "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
        "contents": {
          "type": "bubble",
          "size": "mega",
          "header": {
            "type": "box",
            "layout": "vertical",
            "contents": [{"type": "text","text": "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!","weight": "bold","size": "lg","color":"#FFD700"}]
          },
          "body": {
            "type": "box",
            "layout": "vertical",
            "contents": carList.map(car => ({
              "type":"box","layout":"vertical",
              "margin":"md",
              "contents": [
                {"type":"text","text":`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${car.carNo}`,"weight":"bold"},
                {"type":"text","text":`‡∏ä‡∏∑‡πà‡∏≠: ${car.name}`},
                {"type":"text","text":`‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${car.tel}`}
              ]
            }))
          }
        }
      };
      await liff.sendMessages([flex]);
    }

    function closeWindow(){
      if(liff.isInClient()) liff.closeWindow();
      else window.close();
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนใช้งาน</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="tel"], input[type="file"], button {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button { background-color: #00B900; color: white; font-size: 16px; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #message { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #profilePicPreview { max-width: 100px; max-height: 100px; display: block; margin-top: 10px; }
        #closeButton { background-color: #6c757d; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ลงทะเบียนใช้งาน</h1>
    <div id="loading" style="display: none;">กำลังโหลด...</div>
    <div id="registerFormContainer">
        <form id="registerForm">
            <div class="form-group">
                <label for="firstName">ชื่อจริง:</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">นามสกุล:</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="nickname">ชื่อเล่น:</label>
                <input type="text" id="nickname" name="nickname" required>
            </div>
            <div class="form-group">
                <label for="phone">เบอร์โทรศัพท์:</label>
                <input type="tel" id="phone" name="phone" required>
            </div>
            <div class="form-group">
                <label for="accountNumber">เลขบัญชี:</label>
                <input type="text" id="accountNumber" name="accountNumber" required>
            </div>
             <div class="form-group">
                <label for="bank">ธนาคาร:</label>
                <input type="text" id="bank" name="bank" required>
            </div>
            <div class="form-group">
                <label for="profilePic">รูปประจำตัว:</label>
                <input type="file" id="profilePic" name="profilePic" accept="image/*">
                <img id="profilePicPreview" src="#" alt="ตัวอย่างรูป" style="display: none;" />
            </div>
            <button type="submit" id="submitButton">บันทึกข้อมูล</button>
        </form>
    </div>

    <div id="message" style="display: none;"></div>
    <button id="closeButton" style="display: none;">ปิดหน้าต่างนี้</button>

    <script>
        // ----------------------------------
        // ---     CONFIGURATIONS         ---
        // ----------------------------------
        const LIFF_ID = '2007104190-Qq4B589l'; // <--- ใส่ LIFF ID ของคุณ
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6tLoqtia-GScT3_Aes0pd3HoPrscrEGe5wYzdqJ2u1ATKC9PF0ePe2uOBFDkhqd61/exec'; // <--- ใส่ URL ของ GAS Web App

        // ----------------------------------
        // ---        ELEMENTS            ---
        // ----------------------------------
        const loadingDiv = document.getElementById('loading');
        const formContainer = document.getElementById('registerFormContainer');
        const registerForm = document.getElementById('registerForm');
        const submitButton = document.getElementById('submitButton');
        const messageDiv = document.getElementById('message');
        const closeButton = document.getElementById('closeButton');
        const profilePicInput = document.getElementById('profilePic');
        const profilePicPreview = document.getElementById('profilePicPreview');

        let lineUserId = null;
        let profilePicBase64 = null;

        // ----------------------------------
        // ---      LIFF FUNCTIONS        ---
        // ----------------------------------
        async function initializeLiff() {
            loadingDiv.style.display = 'block';
            formContainer.style.display = 'none';
            messageDiv.style.display = 'none';
            closeButton.style.display = 'none';

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href }); // Redirect back after login
                    return; // Stop execution until page reloads after login
                }

                const profile = await liff.getProfile();
                lineUserId = profile.userId;
                console.log("User ID:", lineUserId);
                formContainer.style.display = 'block'; // Show form after getting userId

            } catch (error) {
                console.error('LIFF Initialization failed:', error);
                showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้: ' + error.message, 'error');
            } finally {
                 loadingDiv.style.display = 'none';
            }
        }

        // ----------------------------------
        // ---     EVENT LISTENERS        ---
        // ----------------------------------
        profilePicInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicBase64 = e.target.result; // Get Base64 string
                    profilePicPreview.src = profilePicBase64;
                    profilePicPreview.style.display = 'block';
                }
                reader.readAsDataURL(file); // Read file
